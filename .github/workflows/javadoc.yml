name: Generate and Deploy Javadoc

on:
  push:
    branches: [ main ]           # Uniquement sur main
    paths:                       # Uniquement si fichiers Java modifiÃ©s
      - 'src/**/*.java'
      - 'pom.xml'
  workflow_dispatch:             # Lancement manuel possible

# ðŸ” PERMISSIONS
# NÃ©cessaire pour Ã©crire sur gh-pages
permissions:
  contents: write                # Ã‰crire dans le repo
  pages: write                   # Ã‰crire sur Pages
  id-token: write                # Token pour dÃ©ploiement

jobs:
  javadoc:
    name: Generate Javadoc
    runs-on: ubuntu-latest
    
    steps:
    # 1ï¸âƒ£ RÃ©cupÃ©rer le code
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0           # RÃ©cupÃ©rer tout l'historique
    
    # 2ï¸âƒ£ Configurer Java
    - name: â˜• Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: 'maven'
    
    # 3ï¸âƒ£ GÃ©nÃ©rer la Javadoc
    - name: ðŸ“š Generate Javadoc
      run: |
        echo "GÃ©nÃ©ration de la Javadoc..."
        mvn clean javadoc:javadoc
        echo "Javadoc gÃ©nÃ©rÃ©e avec succÃ¨s !"
    
    # 4ï¸âƒ£ CrÃ©er .nojekyll
    - name: ðŸ“ Create .nojekyll file
      run: |
        touch docs/.nojekyll
        echo "Fichier .nojekyll crÃ©Ã©"
      # EmpÃªche GitHub Pages d'ignorer les fichiers _*
    
    # 5ï¸âƒ£ CrÃ©er fichier README pour gh-pages
    - name: ðŸ“„ Create README for gh-pages
      run: |
        cat > docs/README.md << 'EOF'
        # Jest Game - Documentation API
        
        Cette page contient la documentation Javadoc gÃ©nÃ©rÃ©e automatiquement.
        
        ðŸ“– [AccÃ©der Ã  la documentation](index.html)
        
        ðŸ”™ [Retour au projet](https://github.com/${{ github.repository }})
        
        ---
        
        *DerniÃ¨re mise Ã  jour : $(date)*
        EOF
    
    # 6ï¸âƒ£ Afficher la structure
    - name: ðŸ—‚ï¸ Display docs structure
      run: |
        echo "Structure du dossier docs/ :"
        ls -la docs/
        echo "Taille totale :"
        du -sh docs/
    
    # 7ï¸âƒ£ DÃ©ployer sur GitHub Pages
    - name: ðŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs       # Dossier Ã  publier
        publish_branch: gh-pages  # Branche de destination
        force_orphan: true        # Nettoyer l'historique
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸ“š Update Javadoc - ${{ github.event.head_commit.message }}'
    
    # 8ï¸âƒ£ CrÃ©er un commentaire (si PR)
    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸ“š Javadoc gÃ©nÃ©rÃ©e avec succÃ¨s !\n\nâœ¨ Preview: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/'
          })